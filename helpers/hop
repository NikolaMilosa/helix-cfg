#!/bin/bash

if [ $# -eq 0 ]; then
  echo "Usage: $0 <pattern...>"
  echo "Examples:"
  echo "  $0 '*.rs'               # open all Rust files"
  echo "  $0 '*.rs' '!tests/*'    # open Rust files except in tests/"
  echo "  $0 '.*\\.txt$' '!.*ignore'  # regex includes and excludes"
  exit 1
fi

includes=()
excludes=()

for arg in "$@"; do
  if [[ "$arg" == !* ]]; then
    # Strip leading !
    excludes+=("${arg:1}")
  else
    includes+=("$arg")
  fi
done

# Start with all files that ripgrep sees (respects .gitignore)
files=$(rg --files)

# Apply includes
if [ ${#includes[@]} -gt 0 ]; then
  inc_regex=$(printf "|%s" "${includes[@]}")
  inc_regex="${inc_regex:1}"   # remove leading |
  files=$(echo "$files" | rg -e "$inc_regex")
fi

# Apply excludes
for ex in "${excludes[@]}"; do
  files=$(echo "$files" | rg -v -e "$ex")
done

if [ -z "$files" ]; then
  echo "No files matched."
  exit 1
fi

helix $files
